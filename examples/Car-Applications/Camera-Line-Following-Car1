#include <Wire.h>
#include <Adafruit_PyCamera.h>
#include <L293D.h>

// Khởi tạo thư viện PyCamera
Adafruit_PyCamera camera;

// Định nghĩa các chân động cơ với mạch L293D
#define MOTOR1_EN 5  // Động cơ 1
#define MOTOR1_IN1 4
#define MOTOR1_IN2 3

#define MOTOR2_EN 6  // Động cơ 2
#define MOTOR2_IN1 7
#define MOTOR2_IN2 8

#define MOTOR3_EN 9  // Động cơ 3
#define MOTOR3_IN1 10
#define MOTOR3_IN2 11

#define MOTOR4_EN 12 // Động cơ 4
#define MOTOR4_IN1 13
#define MOTOR4_IN2 2

// Cấu hình tốc độ động cơ
#define BASE_SPEED 150
#define TURN_SPEED 100

L293D motor1(MOTOR1_EN, MOTOR1_IN1, MOTOR1_IN2);
L293D motor2(MOTOR2_EN, MOTOR2_IN1, MOTOR2_IN2);
L293D motor3(MOTOR3_EN, MOTOR3_IN1, MOTOR3_IN2);
L293D motor4(MOTOR4_EN, MOTOR4_IN1, MOTOR4_IN2);

// Hàm điều khiển xe tiến thẳng
void moveForward() {
  motor1.setSpeed(BASE_SPEED);
  motor2.setSpeed(BASE_SPEED);
  motor3.setSpeed(BASE_SPEED);
  motor4.setSpeed(BASE_SPEED);

  motor1.forward();
  motor2.forward();
  motor3.forward();
  motor4.forward();
}

// Hàm điều khiển xe rẽ trái
void turnLeft() {
  motor1.setSpeed(TURN_SPEED);
  motor2.setSpeed(TURN_SPEED);
  motor3.setSpeed(TURN_SPEED);
  motor4.setSpeed(TURN_SPEED);

  motor1.backward();  // Bánh trái lùi lại
  motor2.backward();
  motor3.forward();   // Bánh phải tiến lên
  motor4.forward();
}

// Hàm điều khiển xe rẽ phải
void turnRight() {
  motor1.setSpeed(TURN_SPEED);
  motor2.setSpeed(TURN_SPEED);
  motor3.setSpeed(TURN_SPEED);
  motor4.setSpeed(TURN_SPEED);

  motor1.forward();   // Bánh trái tiến lên
  motor2.forward();
  motor3.backward();  // Bánh phải lùi lại
  motor4.backward();
}

// Hàm dừng xe
void stopMotors() {
  motor1.stop();
  motor2.stop();
  motor3.stop();
  motor4.stop();
}

void setup() {
  // Khởi tạo động cơ
  motor1.begin();
  motor2.begin();
  motor3.begin();
  motor4.begin();

  // Khởi tạo giao tiếp camera
  if (!camera.begin()) {
    Serial.println("Không thể khởi tạo camera! Hãy kiểm tra kết nối.");
    while (1);
  }
  
  Serial.begin(115200);
  Serial.println("Camera khởi động thành công. Bắt đầu dò line...");
}

void loop() {
  // Chụp hình từ camera
  if (!camera.capture()) {
    Serial.println("Không thể chụp hình.");
    stopMotors();
    return;
  }

  // Xử lý ảnh và xác định vị trí của vạch line
  int linePosition = camera.detectLine(); // detectLine() trả về vị trí của vạch line
  Serial.print("Vị trí vạch line: ");
  Serial.println(linePosition);

  // Điều khiển xe dựa vào vị trí vạch line
  if (linePosition == -1) {
    // Không tìm thấy vạch line
    stopMotors();
    Serial.println("Không tìm thấy vạch line.");
  } else if (linePosition < 30) {
    // Vạch line lệch sang trái
    turnLeft();
    Serial.println("Rẽ trái.");
  } else if (linePosition > 70) {
    // Vạch line lệch sang phải
    turnRight();
    Serial.println("Rẽ phải.");
  } else {
    // Vạch line ở giữa
    moveForward();
    Serial.println("Tiến thẳng.");
  }

  delay(50); // Thời gian lặp
}
